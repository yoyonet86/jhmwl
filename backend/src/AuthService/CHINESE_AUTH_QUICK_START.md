# ä¸­æ–‡è®¤è¯ç³»ç»Ÿ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ç³»ç»Ÿæ¦‚è¿°

å®Œå…¨æœ¬åœ°åŒ–çš„è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- âœ… æ‰‹æœºå·ä½œä¸ºç”¨æˆ·åï¼ˆä¸ä½¿ç”¨é‚®ç®±ï¼‰
- âœ… çŸ­ä¿¡éªŒè¯ç ç™»å½•
- âœ… å¯†ç ç™»å½• + å›¾å½¢éªŒè¯ç 
- âœ… JWT ä»¤ç‰Œç®¡ç†
- âœ… å¤šç§ç™»å½•æ–¹å¼é€‰æ‹©

## å¿«é€Ÿå¼€å§‹ (5 åˆ†é’Ÿ)

### 1. å¯åŠ¨æœåŠ¡

```bash
cd backend/src/AuthService
dotnet run
```

æœåŠ¡åœ°å€: `http://localhost:5001`

### 2. è·å–éªŒè¯ç 

```bash
curl -X POST http://localhost:5001/api/v1/auth/captcha
```

å“åº”ç¤ºä¾‹:
```json
{
  "success": true,
  "challengeKey": "a1b2c3d4e5f6...",
  "challenge": "7 - 2 = ?",
  "expiresIn": 300
}
```

### 3. éªŒè¯éªŒè¯ç 

```bash
curl -X POST http://localhost:5001/api/v1/auth/verify-captcha \
  -H "Content-Type: application/json" \
  -d '{
    "challengeKey": "a1b2c3d4e5f6...",
    "answer": "5"
  }'
```

### 4. å¯†ç ç™»å½•

```bash
curl -X POST http://localhost:5001/api/v1/auth/login/password \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "AdminP@ssw0rd123",
    "captchaKey": "a1b2c3d4e5f6..."
  }'
```

å“åº”ç¤ºä¾‹:
```json
{
  "success": true,
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "base64-encoded-token",
  "user": {
    "id": 1,
    "phone": "13800138000",
    "firstName": "ç³»ç»Ÿ",
    "lastName": "ç®¡ç†å‘˜",
    "organizationId": 1,
    "roles": ["Platform Administrator"],
    "permissions": []
  }
}
```

## ç™»å½•æµç¨‹

### æ–¹æ³• 1: çŸ­ä¿¡éªŒè¯ç ç™»å½• (æ¨èç”¨äºç§»åŠ¨åº”ç”¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥æ‰‹æœºå·  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/request-code    â”‚ 
â”‚  { "phone": "13800138000" }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå‘é€éªŒè¯ç åˆ°æ‰‹æœº              â”‚
â”‚  "éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥çœ‹çŸ­ä¿¡"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥éªŒè¯ç                      â”‚
â”‚  (æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿï¼Œæœ€å¤š 3 æ¬¡å°è¯•)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/login/code      â”‚
â”‚  {                                 â”‚
â”‚    "phone": "13800138000",         â”‚
â”‚    "code": "123456"                â”‚
â”‚  }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› AccessToken å’Œ RefreshToken   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ³• 2: å¯†ç  + éªŒè¯ç ç™»å½• (ç”¨äºç½‘é¡µåº”ç”¨)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”ŸæˆéªŒè¯ç é¢˜ç›®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/captcha         â”‚
â”‚  å“åº”: "5 + 3 = ?"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è§£ç­”éªŒè¯ç                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/verify-captcha  â”‚
â”‚  éªŒè¯ç­”æ¡ˆæ˜¯å¦æ­£ç¡®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v1/auth/login/password      â”‚
â”‚  {                                     â”‚
â”‚    "phone": "13800138000",             â”‚
â”‚    "password": "AdminP@ssw0rd123",     â”‚
â”‚    "captchaKey": "xxx..."              â”‚
â”‚  }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› AccessToken å’Œ RefreshToken     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ç«¯ç‚¹é€ŸæŸ¥è¡¨

| æ“ä½œ | æ–¹æ³• | è·¯å¾„ | è®¤è¯ |
|------|------|------|------|
| åˆ›å»ºéªŒè¯ç  | POST | `/api/v1/auth/captcha` | æ—  |
| éªŒè¯éªŒè¯ç  | POST | `/api/v1/auth/verify-captcha` | æ—  |
| è¯·æ±‚çŸ­ä¿¡ç  | POST | `/api/v1/auth/request-code` | æ—  |
| å¯†ç ç™»å½• | POST | `/api/v1/auth/login/password` | æ—  |
| çŸ­ä¿¡ç ç™»å½• | POST | `/api/v1/auth/login/code` | æ—  |
| åˆ·æ–°ä»¤ç‰Œ | POST | `/api/v1/auth/refresh` | æœ‰ |
| ç™»å‡º | POST | `/api/v1/auth/logout` | æœ‰ |
| è·å–ç”¨æˆ· | GET | `/api/v1/auth/me` | æœ‰ |

## åœ¨å…¶ä»–æœåŠ¡ä¸­ä½¿ç”¨ä»¤ç‰Œ

### æ·»åŠ åˆ°è¯·æ±‚å¤´

```bash
curl -H "Authorization: Bearer <accessToken>" \
  http://localhost:5002/api/v1/orders
```

### åœ¨ä»£ç ä¸­ä½¿ç”¨

```csharp
// æå–ç”¨æˆ·ä¿¡æ¯
var userId = User.FindFirst("sub")?.Value;
var phone = User.FindFirst("phone")?.Value;
var organizationId = User.FindFirst("organization_id")?.Value;
var roles = User.FindAll("role");

// æ£€æŸ¥æƒé™
if (User.IsInRole("MANAGER"))
{
    // ç»ç†æƒé™çš„æ“ä½œ
}
```

## é»˜è®¤æµ‹è¯•è´¦æˆ·

```
æ‰‹æœºå·: 13800138000
å¯†ç : AdminP@ssw0rd123
è§’è‰²: å¹³å°ç®¡ç†å‘˜
```

âš ï¸ **è­¦å‘Š**: ç”Ÿäº§ç¯å¢ƒè¯·ç«‹å³æ›´æ”¹ï¼

## å¸¸è§é”™è¯¯å¤„ç†

### é”™è¯¯ 1: "CAPTCHA verification required"

**åŸå› **: æ²¡æœ‰éªŒè¯éªŒè¯ç æˆ–éªŒè¯ç å·²è¿‡æœŸ
**è§£å†³**: é‡æ–°åˆ›å»ºéªŒè¯ç å¹¶éªŒè¯

```bash
# 1. åˆ›å»ºéªŒè¯ç 
POST /api/v1/auth/captcha

# 2. éªŒè¯ç­”æ¡ˆ
POST /api/v1/auth/verify-captcha

# 3. ä½¿ç”¨ captchaKey ç™»å½•
POST /api/v1/auth/login/password
```

### é”™è¯¯ 2: "Invalid verification code"

**åŸå› **: éªŒè¯ç é”™è¯¯ã€è¿‡æœŸæˆ–å·²ç”¨å°½å°è¯•æ¬¡æ•°
**è§£å†³**: é‡æ–°è¯·æ±‚æ–°çš„éªŒè¯ç 

```bash
POST /api/v1/auth/request-code
{ "phone": "13800138000" }
```

### é”™è¯¯ 3: "User account is locked"

**åŸå› **: ç™»å½•å¤±è´¥è¶…è¿‡ 5 æ¬¡
**è§£å†³**: ç­‰å¾… 30 åˆ†é’Ÿåé‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜

## æµ‹è¯•è„šæœ¬

### Linux/Mac æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash

API_URL="http://localhost:5001/api/v1/auth"
PHONE="13800138000"
PASSWORD="AdminP@ssw0rd123"

# 1. åˆ›å»ºéªŒè¯ç 
echo "=== 1. åˆ›å»ºéªŒè¯ç  ==="
CAPTCHA=$(curl -s -X POST $API_URL/captcha)
CHALLENGE_KEY=$(echo $CAPTCHA | jq -r '.challengeKey')
CHALLENGE=$(echo $CAPTCHA | jq -r '.challenge')
echo "éªŒè¯ç é¢˜ç›®: $CHALLENGE"
echo "è¯·æ‰‹åŠ¨å›ç­”é¢˜ç›®..."
read ANSWER

# 2. éªŒè¯éªŒè¯ç 
echo -e "\n=== 2. éªŒè¯éªŒè¯ç  ==="
curl -s -X POST $API_URL/verify-captcha \
  -H "Content-Type: application/json" \
  -d "{\"challengeKey\": \"$CHALLENGE_KEY\", \"answer\": \"$ANSWER\"}" | jq .

# 3. ç™»å½•
echo -e "\n=== 3. å¯†ç ç™»å½• ==="
LOGIN=$(curl -s -X POST $API_URL/login/password \
  -H "Content-Type: application/json" \
  -d "{
    \"phone\": \"$PHONE\",
    \"password\": \"$PASSWORD\",
    \"captchaKey\": \"$CHALLENGE_KEY\"
  }")

echo $LOGIN | jq .
ACCESS_TOKEN=$(echo $LOGIN | jq -r '.accessToken')

# 4. è·å–ç”¨æˆ·ä¿¡æ¯
echo -e "\n=== 4. è·å–ç”¨æˆ·ä¿¡æ¯ ==="
curl -s -X GET $API_URL/me \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

### Windows PowerShell æµ‹è¯•è„šæœ¬

```powershell
$API_URL = "http://localhost:5001/api/v1/auth"
$PHONE = "13800138000"
$PASSWORD = "AdminP@ssw0rd123"

# 1. åˆ›å»ºéªŒè¯ç 
Write-Host "=== 1. åˆ›å»ºéªŒè¯ç  ===" 
$captcha = Invoke-WebRequest -Uri "$API_URL/captcha" -Method POST | ConvertFrom-Json
$challengeKey = $captcha.challengeKey
$challenge = $captcha.challenge
Write-Host "éªŒè¯ç é¢˜ç›®: $challenge"
$answer = Read-Host "è¯·è¾“å…¥ç­”æ¡ˆ"

# 2. éªŒè¯éªŒè¯ç 
Write-Host "`n=== 2. éªŒè¯éªŒè¯ç  ==="
$body = @{
    challengeKey = $challengeKey
    answer = $answer
} | ConvertTo-Json
Invoke-WebRequest -Uri "$API_URL/verify-captcha" `
    -Method POST -ContentType "application/json" `
    -Body $body | ConvertFrom-Json | ConvertTo-Json

# 3. ç™»å½•
Write-Host "`n=== 3. å¯†ç ç™»å½• ==="
$body = @{
    phone = $PHONE
    password = $PASSWORD
    captchaKey = $challengeKey
} | ConvertTo-Json
$login = Invoke-WebRequest -Uri "$API_URL/login/password" `
    -Method POST -ContentType "application/json" `
    -Body $body | ConvertFrom-Json
$login | ConvertTo-Json
$accessToken = $login.accessToken

# 4. è·å–ç”¨æˆ·ä¿¡æ¯
Write-Host "`n=== 4. è·å–ç”¨æˆ·ä¿¡æ¯ ==="
Invoke-WebRequest -Uri "$API_URL/me" `
    -Method GET `
    -Headers @{ Authorization = "Bearer $accessToken" } | ConvertFrom-Json | ConvertTo-Json
```

## ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°å‰ç«¯**: å®ç°ç™»å½•é¡µé¢å’Œä»¤ç‰Œç®¡ç†
2. **é…ç½® SMS**: é›†æˆçœŸå®çš„çŸ­ä¿¡æœåŠ¡
3. **åŠ å¼ºå®‰å…¨**: é…ç½® HTTPS å’Œ CORS
4. **ç›‘æ§æ—¥å¿—**: è®¾ç½®å®¡è®¡å’Œå‘Šè­¦
5. **ç”¨æˆ·ç®¡ç†**: å®ç°ç”¨æˆ·åˆ›å»ºå’Œç®¡ç†æ¥å£

## æ›´å¤šèµ„æº

- ğŸ“– è¯¦ç»†æ–‡æ¡£: `README_CHINESE.md`
- ğŸ”— é›†æˆæŒ‡å—: `docs/backend/AUTH_INTEGRATION_GUIDE.md`
- ğŸ—„ï¸ æ•°æ®åº“è¿ç§»: `db/MIGRATION_GUIDE.md`
- ğŸš€ éƒ¨ç½²æŒ‡å—: `SETUP_GUIDE.md`
